# Remote CI Supervisor 配置文件
# 适用于 Docker 容器或禁用 systemd 的环境
#
# 使用方法:
#   1. 复制到 /etc/supervisor/conf.d/ 目录
#   2. 修改路径和用户配置
#   3. 运行: supervisorctl reread && supervisorctl update

[program:remote-ci-redis]
command=redis-server --daemonize no --appendonly yes --dir /var/lib/remote-ci
user=ci-user
autostart=true
autorestart=true
startretries=3
stdout_logfile=/var/log/remote-ci/redis.log
stderr_logfile=/var/log/remote-ci/redis.log
priority=10

[program:remote-ci-api]
command=/opt/remote-ci/venv/bin/python -m server.app
directory=/opt/remote-ci
user=ci-user
environment=PATH="/opt/remote-ci/venv/bin"
autostart=true
autorestart=true
startretries=3
stdout_logfile=/var/log/remote-ci/api.log
stderr_logfile=/var/log/remote-ci/api.log
priority=20

[program:remote-ci-worker]
command=/opt/remote-ci/venv/bin/celery -A server.celery_app worker --loglevel=info --concurrency=2
directory=/opt/remote-ci
user=ci-user
environment=PATH="/opt/remote-ci/venv/bin"
autostart=true
autorestart=true
startretries=3
stdout_logfile=/var/log/remote-ci/worker.log
stderr_logfile=/var/log/remote-ci/worker.log
stopwaitsecs=60
stopasgroup=true
killasgroup=true
priority=30

[program:remote-ci-flower]
command=/opt/remote-ci/venv/bin/celery -A server.celery_app flower --port=5555
directory=/opt/remote-ci
user=ci-user
environment=PATH="/opt/remote-ci/venv/bin"
autostart=false
autorestart=true
startretries=3
stdout_logfile=/var/log/remote-ci/flower.log
stderr_logfile=/var/log/remote-ci/flower.log
priority=40

[group:remote-ci]
programs=remote-ci-redis,remote-ci-api,remote-ci-worker
priority=999
