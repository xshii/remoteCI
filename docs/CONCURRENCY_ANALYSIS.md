# Remote CI å¹¶å‘åœºæ™¯åˆ†æ

## é—®é¢˜ï¼šä¸¤ä¸ªäººåŒæ—¶æäº¤ä»»åŠ¡ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

### ğŸ“Š å½“å‰ç³»ç»Ÿè¡Œä¸ºåˆ†æ

#### 1ï¸âƒ£ **ä¸Šä¼ æ¨¡å¼ï¼ˆUpload Modeï¼‰**

##### æ–‡ä»¶å­˜å‚¨æœºåˆ¶
```python
# app.py ç¬¬143-145è¡Œ
timestamp = datetime.now().strftime('%Y%m%d-%H%M%S')  # âš ï¸ ç§’çº§ç²¾åº¦
saved_filename = f"{timestamp}-{filename}"
upload_path = f"{DATA_DIR}/uploads/{saved_filename}"
```

##### ä»»åŠ¡æ‰§è¡Œéš”ç¦»
```python
# tasks.py ç¬¬64è¡Œ
work_dir = f"{WORK_DIR}/{task_id}"  # âœ… æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹ç›®å½•
repo_dir = f"{work_dir}/repo"
```

##### âš ï¸ **æ½œåœ¨é—®é¢˜1ï¼šæ–‡ä»¶åå†²çª**

**åœºæ™¯ç¤ºä¾‹ï¼š**
```
æ—¶é—´: 2024-01-15 10:30:45.123
ç”¨æˆ·Aä¸Šä¼ : code.tar.gz â†’ 20240115-103045-code.tar.gz
ç”¨æˆ·Bä¸Šä¼ : code.tar.gz â†’ 20240115-103045-code.tar.gz  # âš ï¸ åŒä¸€ç§’å†…ä¸Šä¼ ï¼Œæ–‡ä»¶åå†²çªï¼
```

**åæœï¼š**
- ç”¨æˆ·Bçš„æ–‡ä»¶ä¼š**è¦†ç›–**ç”¨æˆ·Açš„æ–‡ä»¶
- ç”¨æˆ·Açš„ä»»åŠ¡åœ¨æ‰§è¡Œæ—¶ä¼šè§£å‹ç”¨æˆ·Bçš„ä»£ç ï¼ˆå¦‚æœæ–‡ä»¶å·²è¢«è¦†ç›–ï¼‰
- ç”¨æˆ·Açš„åŸå§‹ä»£ç åŒ…**ä¸¢å¤±**

**å‘ç”Ÿæ¦‚ç‡ï¼š**
- ä½ï¼ˆç§’çº§å†²çªéœ€è¦æç«¯å·§åˆï¼‰
- ä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ˆå¤šäººé¢‘ç¹æäº¤ï¼‰æ¦‚ç‡ä¸Šå‡

---

#### 2ï¸âƒ£ **rsyncæ¨¡å¼ï¼ˆRsync Modeï¼‰**

##### Workspaceæœºåˆ¶
```python
# app.py ç¬¬102-107è¡Œ
workspace = data['workspace']  # ä¾‹å¦‚ï¼š/var/ci-workspace/myproject
task = execute_build.delay({
    'workspace': workspace,  # âœ… ä¼ é€’ç»™ä»»åŠ¡
    ...
})
```

##### ä»£ç å¤åˆ¶è¿‡ç¨‹
```python
# tasks.py ç¬¬98-109è¡Œ
workspace = job_data['workspace']  # /var/ci-workspace/myproject
repo_dir = f"{work_dir}/repo"      # /tmp/remote-ci/{task_id}/repo
shutil.copytree(workspace, repo_dir)  # å¤åˆ¶åˆ°ä»»åŠ¡ä¸“å±ç›®å½•
```

##### âš ï¸ **ä¸¥é‡é—®é¢˜ï¼šWorkspaceç«äº‰æ¡ä»¶**

**åœºæ™¯ç¤ºä¾‹ï¼š**

```bash
æ—¶é—´çº¿ï¼š
10:30:00 - ç”¨æˆ·A rsyncä»£ç åˆ° /var/ci-workspace/myproject (version A)
10:30:01 - ç”¨æˆ·Aæäº¤ä»»åŠ¡Aï¼ŒçŠ¶æ€ï¼šqueued
10:30:02 - ç”¨æˆ·B rsyncä»£ç åˆ° /var/ci-workspace/myproject (version B) â† âš ï¸ è¦†ç›–ï¼
10:30:03 - ç”¨æˆ·Bæäº¤ä»»åŠ¡Bï¼ŒçŠ¶æ€ï¼šqueued
10:30:05 - Workerå¼€å§‹æ‰§è¡Œä»»åŠ¡Aï¼Œä» workspace å¤åˆ¶ä»£ç 
          âš ï¸ æ­¤æ—¶å¤åˆ¶çš„æ˜¯ç”¨æˆ·Bçš„ä»£ç ï¼ˆversion Bï¼‰ï¼
10:30:10 - Workerå¼€å§‹æ‰§è¡Œä»»åŠ¡Bï¼Œä» workspace å¤åˆ¶ä»£ç 
          âœ“ å¤åˆ¶çš„æ˜¯ç”¨æˆ·Bçš„ä»£ç ï¼ˆversion Bï¼‰
```

**å®é™…ç»“æœï¼š**
- âŒ **ç”¨æˆ·Açš„ä»»åŠ¡æ‰§è¡Œçš„æ˜¯ç”¨æˆ·Bçš„ä»£ç **
- âŒ **ç”¨æˆ·Aæ— æ³•é‡ç°æ„å»ºç»“æœ**
- âŒ **æ—¥å¿—æ˜¾ç¤º"æˆåŠŸ"ï¼Œä½†æµ‹è¯•çš„æ˜¯é”™è¯¯çš„ä»£ç **

**å‘ç”Ÿæ¦‚ç‡ï¼š**
- **æé«˜**ï¼ˆåªè¦ä½¿ç”¨ç›¸åŒçš„é¡¹ç›®åç§°ï¼‰
- åŒä¸€å›¢é˜Ÿçš„æˆå‘˜é€šå¸¸ä¼šä½¿ç”¨ç›¸åŒçš„é¡¹ç›®å

---

### ğŸ” è¯¦ç»†åœºæ™¯å¯¹æ¯”

#### åœºæ™¯1ï¼šä¸Šä¼ æ¨¡å¼ - æ— å†²çªï¼ˆæ­£å¸¸æƒ…å†µï¼‰

| æ—¶é—´ | ç”¨æˆ·A | ç”¨æˆ·B | ç»“æœ |
|------|------|------|------|
| 10:30:00 | ä¸Šä¼ ä»£ç  â†’ `103000-code.tar.gz` | - | âœ“ |
| 10:30:05 | - | ä¸Šä¼ ä»£ç  â†’ `103005-code.tar.gz` | âœ“ |
| 10:30:10 | ä»»åŠ¡Aæ‰§è¡Œï¼ˆä½¿ç”¨ `103000-code.tar.gz`ï¼‰ | - | âœ“ |
| 10:30:15 | - | ä»»åŠ¡Bæ‰§è¡Œï¼ˆä½¿ç”¨ `103005-code.tar.gz`ï¼‰ | âœ“ |

**ç»“è®ºï¼šâœ… å®Œç¾éš”ç¦»ï¼Œæ— é—®é¢˜**

---

#### åœºæ™¯2ï¼šä¸Šä¼ æ¨¡å¼ - ç§’çº§å†²çªï¼ˆç½•è§ï¼‰

| æ—¶é—´ | ç”¨æˆ·A | ç”¨æˆ·B | ç»“æœ |
|------|------|------|------|
| 10:30:00.123 | ä¸Šä¼ ä»£ç  â†’ `103000-code.tar.gz` | - | âœ“ |
| 10:30:00.789 | - | ä¸Šä¼ ä»£ç  â†’ `103000-code.tar.gz` â† è¦†ç›–ï¼ | âš ï¸ |
| 10:30:05 | ä»»åŠ¡Aæ‰§è¡Œ | - | âŒ ä½¿ç”¨äº†Bçš„ä»£ç ï¼ |
| 10:30:10 | - | ä»»åŠ¡Bæ‰§è¡Œ | âœ“ ä½¿ç”¨äº†Bçš„ä»£ç  |

**ç»“è®ºï¼šâš ï¸ ç½•è§ä½†å¯èƒ½å‘ç”Ÿï¼Œå¯¼è‡´Aæ‰§è¡Œé”™è¯¯ä»£ç **

---

#### åœºæ™¯3ï¼šrsyncæ¨¡å¼ - Workspaceå†²çªï¼ˆå¸¸è§ä¸”ä¸¥é‡ï¼‰

| æ—¶é—´ | ç”¨æˆ·A | ç”¨æˆ·B | Workspaceå†…å®¹ |
|------|------|------|--------------|
| 10:30:00 | rsync â†’ `/var/ci-workspace/myapp` | - | Açš„ä»£ç  v1.0 |
| 10:30:01 | æäº¤ä»»åŠ¡Aï¼ˆqueuedï¼‰ | - | Açš„ä»£ç  v1.0 |
| 10:30:02 | - | rsync â†’ `/var/ci-workspace/myapp` | **Bçš„ä»£ç  v2.0** â† è¦†ç›–ï¼ |
| 10:30:03 | - | æäº¤ä»»åŠ¡Bï¼ˆqueuedï¼‰ | Bçš„ä»£ç  v2.0 |
| 10:30:05 | Workeræ‰§è¡Œä»»åŠ¡A | - | âŒ å¤åˆ¶äº†Bçš„ä»£ç v2.0ï¼ |
| 10:30:10 | - | Workeræ‰§è¡Œä»»åŠ¡B | âœ“ å¤åˆ¶äº†Bçš„ä»£ç v2.0 |

**ç»“è®ºï¼šâŒ ä¸¥é‡é—®é¢˜ï¼Açš„ä»»åŠ¡æ‰§è¡Œäº†Bçš„ä»£ç **

---

### ğŸ› å®é™…æ¡ˆä¾‹æ¼”ç¤º

#### æ¡ˆä¾‹1ï¼šå›¢é˜Ÿåä½œBug

```yaml
# å›¢é˜Ÿæˆå‘˜éƒ½ä½¿ç”¨é¡¹ç›®å "myapp"

å¼€å‘è€…Alice:
  æäº¤æ—¶é—´: 10:00:00
  ä»£ç ç‰ˆæœ¬: feature-login (æœ‰bug)
  rsync â†’ /var/ci-workspace/myapp
  æäº¤ä»»åŠ¡: task-001 (queued)

å¼€å‘è€…Bob:
  æäº¤æ—¶é—´: 10:00:05
  ä»£ç ç‰ˆæœ¬: feature-payment (æ­£å¸¸)
  rsync â†’ /var/ci-workspace/myapp  â† è¦†ç›–äº†Aliceçš„ä»£ç ï¼
  æäº¤ä»»åŠ¡: task-002 (queued)

Workeræ‰§è¡Œ:
  10:00:10 - æ‰§è¡Œ task-001
    æœŸæœ›: æµ‹è¯• feature-login
    å®é™…: æµ‹è¯• feature-payment â† âŒ é”™è¯¯ï¼
    ç»“æœ: æ˜¾ç¤º"æˆåŠŸ"ï¼Œä½†Aliceçš„bugæœªè¢«æ£€æµ‹åˆ°

  10:00:20 - æ‰§è¡Œ task-002
    æœŸæœ›: æµ‹è¯• feature-payment
    å®é™…: æµ‹è¯• feature-payment â† âœ“ æ­£ç¡®
    ç»“æœ: æˆåŠŸ
```

**å½±å“ï¼š**
- Aliceè®¤ä¸ºå¥¹çš„ä»£ç é€šè¿‡äº†CI âŒ
- å¸¦bugçš„ä»£ç è¢«åˆå¹¶åˆ°ä¸»åˆ†æ”¯ âŒ
- ç”Ÿäº§ç¯å¢ƒå‡ºç°æ•…éšœ âŒ

---

### ğŸ’¡ æ¨èçš„è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šä¿®å¤ä¸Šä¼ æ¨¡å¼çš„æ—¶é—´æˆ³ç²¾åº¦ï¼ˆç®€å•ï¼‰

```python
# app.py ä¿®æ”¹
# åŸä»£ç ï¼š
timestamp = datetime.now().strftime('%Y%m%d-%H%M%S')  # ç§’çº§

# æ”¹è¿›ï¼š
import uuid
timestamp = datetime.now().strftime('%Y%m%d-%H%M%S')
unique_id = uuid.uuid4().hex[:8]
saved_filename = f"{timestamp}-{unique_id}-{filename}"
```

**ä¼˜ç‚¹ï¼š**
- âœ… å®Œå…¨æ¶ˆé™¤æ–‡ä»¶åå†²çª
- âœ… ç®€å•æ˜“å®ç°
- âœ… å‘åå…¼å®¹

---

#### æ–¹æ¡ˆ2ï¼šä¿®å¤rsyncæ¨¡å¼çš„Workspaceéš”ç¦»ï¼ˆæ¨èï¼‰

```python
# app.py ä¿®æ”¹
@app.route('/api/jobs/rsync', methods=['POST'])
@require_auth
def create_rsync_job():
    data = request.json
    workspace = data['workspace']

    # ç”Ÿæˆå”¯ä¸€çš„ä»»åŠ¡ID
    task_id = str(uuid.uuid4())

    # åˆ›å»ºä»»åŠ¡ä¸“å±çš„workspaceå‰¯æœ¬
    task_workspace = f"{WORKSPACE_DIR}/.task-{task_id}"
    shutil.copytree(workspace, task_workspace)

    # æäº¤ä»»åŠ¡æ—¶ä½¿ç”¨å‰¯æœ¬
    task = execute_build.delay({
        'mode': 'rsync',
        'workspace': task_workspace,  # ä½¿ç”¨å‰¯æœ¬è€Œä¸æ˜¯åŸå§‹workspace
        'script': data['script'],
        'user': data.get('user', 'anonymous')
    })

    return jsonify({
        'job_id': task.id,
        'status': 'queued',
        'mode': 'rsync'
    }), 201
```

**ä¼˜ç‚¹ï¼š**
- âœ… å®Œå…¨éš”ç¦»æ¯ä¸ªä»»åŠ¡çš„ä»£ç 
- âœ… é¿å…ç«äº‰æ¡ä»¶
- âœ… ä¿è¯æ„å»ºå¯é‡ç°æ€§

**ç¼ºç‚¹ï¼š**
- âš ï¸ å¢åŠ ç£ç›˜ç©ºé—´ä½¿ç”¨ï¼ˆæ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä»£ç å‰¯æœ¬ï¼‰
- âš ï¸ rsyncçš„å¢é‡åŒæ­¥ä¼˜åŠ¿éƒ¨åˆ†ä¸§å¤±

---

#### æ–¹æ¡ˆ3ï¼šä½¿ç”¨é”æœºåˆ¶ï¼ˆå¤æ‚ï¼‰

```python
import fcntl

def acquire_workspace_lock(workspace):
    lock_file = f"{workspace}/.ci-lock"
    f = open(lock_file, 'w')
    fcntl.flock(f, fcntl.LOCK_EX)  # æ’ä»–é”
    return f

def release_workspace_lock(lock):
    fcntl.flock(lock, fcntl.LOCK_UN)
    lock.close()
```

**ä¼˜ç‚¹ï¼š**
- âœ… ä¿æŠ¤workspaceä¸è¢«å¹¶å‘ä¿®æ”¹

**ç¼ºç‚¹ï¼š**
- âŒ å¤æ‚åº¦é«˜
- âŒ å¯èƒ½å¯¼è‡´ä»»åŠ¡ç­‰å¾…
- âŒ éœ€è¦å¤„ç†æ­»é”

---

### ğŸ“ æœ€ä½³å®è·µå»ºè®®

#### å¯¹äºç”¨æˆ·ï¼š

1. **æ¨èä½¿ç”¨ä¸Šä¼ æ¨¡å¼**
   ```bash
   # âœ… æ¨è
   python3 submit-upload.py "npm test"
   ```

2. **å¦‚æœå¿…é¡»ä½¿ç”¨rsyncæ¨¡å¼ï¼Œä½¿ç”¨å”¯ä¸€çš„é¡¹ç›®å**
   ```bash
   # âŒ ä¸æ¨èï¼ˆå›¢é˜Ÿå…±äº«åŒä¸€ä¸ªworkspaceï¼‰
   python3 submit-rsync.py "myapp" "npm test"

   # âœ… æ¨èï¼ˆæ¯ä¸ªç”¨æˆ·/åˆ†æ”¯ä½¿ç”¨ä¸åŒworkspaceï¼‰
   PROJECT_NAME="myapp-${USER}-${CI_COMMIT_REF_NAME}"
   python3 submit-rsync.py "$PROJECT_NAME" "npm test"
   ```

3. **GitLab CIç¤ºä¾‹ï¼š**
   ```yaml
   variables:
     # ä½¿ç”¨ç”¨æˆ·åå’Œåˆ†æ”¯åç¡®ä¿å”¯ä¸€æ€§
     WORKSPACE_NAME: "${CI_PROJECT_NAME}-${GITLAB_USER_LOGIN}-${CI_COMMIT_REF_SLUG}"

   script:
     - python3 submit-rsync.py "$WORKSPACE_NAME" "npm test"
   ```

---

### ğŸ”’ å®‰å…¨æ€§æ£€æŸ¥æ¸…å•

- [ ] ä¸Šä¼ æ¨¡å¼ä½¿ç”¨æ¯«ç§’çº§æˆ–UUIDç¡®ä¿æ–‡ä»¶åå”¯ä¸€
- [ ] rsyncæ¨¡å¼çš„workspaceåŒ…å«ç”¨æˆ·å/åˆ†æ”¯å
- [ ] å›¢é˜Ÿæˆå‘˜äº†è§£å¹¶å‘é£é™©
- [ ] åœ¨æ–‡æ¡£ä¸­è¯´æ˜æœ€ä½³å®è·µ
- [ ] è€ƒè™‘åœ¨APIå±‚æ·»åŠ å¹¶å‘æ§åˆ¶
- [ ] ç›‘æ§æ—¥å¿—ä¸­çš„æ–‡ä»¶å†²çªè­¦å‘Š

---

### ğŸ“Š æ€§èƒ½å½±å“å¯¹æ¯”

| è§£å†³æ–¹æ¡ˆ | ç£ç›˜ä½¿ç”¨ | CPUä½¿ç”¨ | å†…å­˜ä½¿ç”¨ | å®ç°éš¾åº¦ |
|---------|---------|---------|---------|---------|
| æ–¹æ¡ˆ1ï¼ˆUUIDï¼‰ | æ— å½±å“ | æ— å½±å“ | æ— å½±å“ | â­ ç®€å• |
| æ–¹æ¡ˆ2ï¼ˆå‰¯æœ¬ï¼‰ | +100% | +20% | +10% | â­â­ ä¸­ç­‰ |
| æ–¹æ¡ˆ3ï¼ˆé”ï¼‰ | æ— å½±å“ | +5% | +5% | â­â­â­ å¤æ‚ |

---

## æ€»ç»“

### å½“å‰çŠ¶æ€ï¼š

| æ¨¡å¼ | å¹¶å‘å®‰å…¨æ€§ | é£é™©ç­‰çº§ | å»ºè®® |
|-----|----------|---------|-----|
| **ä¸Šä¼ æ¨¡å¼** | âš ï¸ åŸºæœ¬å®‰å…¨ï¼ˆç§’çº§å†²çªé£é™©ï¼‰ | ğŸŸ¡ ä½ | æ·»åŠ UUID |
| **rsyncæ¨¡å¼** | âŒ ä¸å®‰å…¨ï¼ˆworkspaceå†²çªï¼‰ | ğŸ”´ é«˜ | ç«‹å³ä¿®å¤ |
| **Gitæ¨¡å¼** | âœ… å®‰å…¨ï¼ˆæ¯æ¬¡å…‹éš†ç‹¬ç«‹ï¼‰ | ğŸŸ¢ æ—  | æ— éœ€æ”¹åŠ¨ |

### ä¼˜å…ˆçº§ï¼š

1. **ç´§æ€¥**ï¼šä¿®å¤rsyncæ¨¡å¼çš„workspaceå†²çªï¼ˆæ–¹æ¡ˆ2ï¼‰
2. **é‡è¦**ï¼šæ”¹è¿›ä¸Šä¼ æ¨¡å¼çš„æ–‡ä»¶åç”Ÿæˆï¼ˆæ–¹æ¡ˆ1ï¼‰
3. **å¯é€‰**ï¼šæ·»åŠ ç›‘æ§å’Œè­¦å‘Šæœºåˆ¶

---

**ç»“è®ºï¼šå½“å‰ç³»ç»Ÿåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å­˜åœ¨ä¸¥é‡çš„ä»£ç æ··æ·†é£é™©ï¼Œå°¤å…¶æ˜¯rsyncæ¨¡å¼ã€‚å»ºè®®ç«‹å³å®æ–½æ–¹æ¡ˆ1å’Œæ–¹æ¡ˆ2ã€‚**
